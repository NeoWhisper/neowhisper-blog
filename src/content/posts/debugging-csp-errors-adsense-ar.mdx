---
title: "من 6 أخطاء CSP إلى صفر: تصحيح سياسة أمن المحتوى لـ AdSense"
date: "2026-02-09"
excerpt: "نصوص AdSense محظورة بواسطة CSP؟ الكونسول مليء بأخطاء frame-src؟ إليك كيف قمت بتصحيح وإصلاح 6 انتهاكات لسياسة أمن المحتوى في الإنتاج—خطوة بخطوة."
category: "Next.js"
coverImage: "/images/csp-debugging-cover.png"
author:
  name: "NeoWhisper"
  picture: "/images/author.png"
---

كنت أعتقد أن موقعنا جاهز لـ AdSense. كود نظيف، إعدادات صحيحة، كل شيء حسب الكتاب. ثم فتحت أدوات المطور (DevTools) مع تعطيل أدوات حظر الإعلانات.

**ستة أخطاء CSP حمراء فاقعة كانت تحدق بي.**

تم حظر كل نص برمجي لـ AdSense. الإعلانات لن تظهر. التتبع لن يعمل. ولم يكن لدي أي فكرة عن النطاقات التي تحتاجها Google فعلياً حتى رأيتها تفشل في الوقت الفعلي.

---

## المشكلة: CSP يحظر كل ما تحتاجه Google

سياسة أمن المحتوى (CSP) هي رأس أمان يخبر المتصفحات: "قم فقط بتحميل الموارد من النطاقات التي أسمح بها صراحة". في Next.js، قد تبدو السياسة الأساسية هكذا:

```tsx
const csp = [
  "default-src 'self'",
  "script-src 'self'",
  "frame-src 'self'",
].join("; ");
```

هذا آمن للغاية. وهو أيضاً سبب توقف AdSense عن العمل—تحتاج Google إلى تحميل نصوص وإطارات خارجية من نطاقات متعددة.

---

<Step number="١" title="إعادة إنتاج المشكلة">

لا تخمن ما هو محظور. شاهد الفشل في الوقت الفعلي باتباع هذه الخطوات:

1. **عطل أدوات حظر الإعلانات** (فهي تخفي أخطاء CSP الحقيقية).
2. افتح DevTools ← **Console**.
3. قم بتحميل صفحتك وابحث عن أخطاء "Refused to load..." الحمراء.
4. **اكتب كل نطاق (domain) محظور.**

</Step>

<Step number="٢" title="فخ بيئة التطوير (Development Environment)">

إذا نظرت فقط إلى أخطاء الإنتاج، ستفوتك متطلبات بيئة التطوير الخاصة.

**في التطوير (Next.js `npm run dev`)، تحتاج إلى تصريحين إضافيين:**

1.  **`unsafe-eval`**: يستخدم Next.js دالة `eval()` للتحديث السريع (HMR).
2.  **`ws://localhost`**: تستخدم إضافات مثل Console Ninja و HMR مقابس الويب (WebSockets).

إذا حظرت هذه الأشياء، ستتعطل بيئة التطوير المحلية لديك.

<Callout type="info">

**الحل:** اسمح بها بشكل مشروط **فقط** في وضع التطوير.

```ts
const isDev = process.env.NODE_ENV === "development";

const scriptSrc = [
  "'self'",
  "'unsafe-inline'",
  isDev ? "'unsafe-eval'" : "", // السماح بـ eval في التطوير
  "https://www.googletagmanager.com",
  // ... نطاقات أخرى
]
  .filter(Boolean)
  .join(" ");

const connectSrc = [
  "'self'",
  isDev ? "ws://localhost:* ws://127.0.0.1:*" : "", // السماح بـ WebSockets في التطوير
  "https://www.google-analytics.com",
  // ... نطاقات أخرى
]
  .filter(Boolean)
  .join(" ");
```

</Callout>

</Step>

<Step number="٣" title="قائمة السماح لـ AdSense">

من خلال التجربة والخطأ، إليك قائمة النطاقات التي يحتاجها Google AdSense فعلياً:

- **script-src:** `googletagmanager.com`, `google-analytics.com`, `pagead2.googlesyndication.com`
- **connect-src:** `googleads.g.doubleclick.net`, `tpc.googlesyndication.com`, `*.google.com`
- **frame-src:** `adtrafficquality.google`, `*.adtrafficquality.google`, `fundingchoicesmessages.google.com`

_ملاحظة: علامة النجمة `*.google.com` ضرورية لأن Google تستخدم نطاقات فرعية غير متوقعة._

</Step>

<Step number="٤" title="الإعداد النهائي النظيف">

إليك الإعداد النهائي في `next.config.ts` الذي يتعامل مع كل من التطوير (HMR) والإنتاج (AdSense):

```tsx
async headers() {
  const isDev = process.env.NODE_ENV === "development";

  const csp = [
    "default-src 'self'",
    `script-src 'self' 'unsafe-inline' ${isDev ? "'unsafe-eval'" : ""} https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com`,
    `connect-src 'self' ${isDev ? "ws://localhost:* ws://127.0.0.1:*" : ""} https://www.google-analytics.com https://www.googletagmanager.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://tpc.googlesyndication.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com https://*.google.com`,
    "frame-src 'self' https://googleads.g.doubleclick.net https://tpc.googlesyndication.com https://*.google.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com",
    "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
    "object-src 'none'",
  ].join("; ");

  return [
    {
      source: "/(.*)",
      headers: [
        { key: "Content-Security-Policy", value: csp },
        // ... رؤوس أخرى
      ],
    },
  ];
}
```

</Step>

---

## قائمة الاختبار النهائية

<Checklist>
  <CheckItem>تحقق من أن `unsafe-eval` مسموح به فقط في التطوير</CheckItem>
  <CheckItem>تحقق من الكونسول في الإنتاج بحثاً عن أي أخطاء حمراء</CheckItem>
  <CheckItem>تأكد من أن `object-src` مضبوط على 'none'</CheckItem>
  <CheckItem>اختبر تحميل AdSense مع تعطيل مانع الإعلانات</CheckItem>
</Checklist>

---

**هل تحتاج مساعدة في تأمين موقع Next.js الخاص بك؟** نحن نتولى الأجزاء الصعبة من CSP والرؤوس والأمان حتى لا تضطر لذلك. تحقق من [خدماتنا](/services?lang=ar) أو [تواصل معنا](/contact?lang=ar) لمناقشة مشروعك.
