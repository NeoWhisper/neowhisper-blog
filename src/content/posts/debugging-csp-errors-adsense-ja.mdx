---
title: "6つのCSPエラーをゼロに：AdSenseのためのコンテンツセキュリティポリシーのデバッグ"
date: "2026-02-09"
excerpt: "AdSenseスクリプトがCSPでブロックされる？コンソールがframe-srcエラーでいっぱい？本番環境で6つのCSP違反をデバッグし、解決したステップを実際のメッセージと共に解説します。"
category: "Next.js"
coverImage: "/images/csp-debugging-cover.png"
author:
  name: "NeoWhisper"
  picture: "/images/author.png"
---

当サイトはAdSenseへの準備が整っていると思っていました。クリーンなコード、適切なセットアップ、すべてがマニュアル通り。しかし、広告ブロックを無効にしてDevToolsを開いた瞬間、状況は一変しました。

**6つの真っ赤なCSPエラーが私を待ち受けていました。**

AdSenseのスクリプトはすべてブロックされ、広告は表示されず、トラッキングも機能しません。Googleが実際にどのドメインを必要としているのか、リアルタイムでエラーを見るまで把握できていませんでした。

---

## 問題：CSPがGoogleの必要とするすべてをブロックする

コンテンツセキュリティポリシー（CSP）は、「明示的に許可したドメインからのリソースのみを読み込む」ようブラウザに指示するセキュリティヘッダーです。Next.jsでの基本的なポリシーは以下のようになります：

```tsx
const csp = [
  "default-src 'self'",
  "script-src 'self'",
  "frame-src 'self'",
].join("; ");
```

これは非常に安全ですが、AdSenseが壊れる理由でもあります。Googleは外部スクリプトやフレームを複数のドメインから読み込む必要があるからです。

---

<Step number="1" title="問題を再現する">

何がブロックされているか推測するのではなく、以下の手順でリアルタイムに失敗を確認します：

1. **広告ブロックを無効にする**（本物のCSPエラーが隠されてしまいます）。
2. DevToolsの **Console（コンソール）** タブを開く。
3. ページを読み込み、赤い「Refused to load...」エラーを探す。
4. **ブロックされているすべてのドメインを書き留める。**

</Step>

<Step number="2" title="開発環境の落とし穴">

本番環境のエラーだけを見ていると、開発環境特有の要件を見逃してしまいます。

**開発中 (Next.js `npm run dev`) は、2つの追加許可が必要です：**

1.  **`unsafe-eval`**: Next.jsはホットリロード（HMR）のために `eval()` を使用します。
2.  **`ws://localhost`**: Console Ninjaなどの拡張機能やHMRはWebSocketを使用します。

これらをブロックすると、ローカル開発環境が壊れてしまいます。

<Callout type="info">

**解決策:** 開発モードの場合にのみ、これらを条件付きで許可します。

```ts
const isDev = process.env.NODE_ENV === "development";

const scriptSrc = [
  "'self'",
  "'unsafe-inline'",
  isDev ? "'unsafe-eval'" : "", // 開発環境のみevalを許可
  "https://www.googletagmanager.com",
  // ... 他のドメイン
]
  .filter(Boolean)
  .join(" ");

const connectSrc = [
  "'self'",
  isDev ? "ws://localhost:* ws://127.0.0.1:*" : "", // 開発環境のみWebSocketを許可
  "https://www.google-analytics.com",
  // ... 他のドメイン
]
  .filter(Boolean)
  .join(" ");
```

</Callout>

</Step>

<Step number="3" title="AdSense許可リスト">

試行錯誤の結果、Google AdSenseが実際に必要とするドメインのリストは以下の通りです：

- **script-src:** `googletagmanager.com`, `google-analytics.com`, `pagead2.googlesyndication.com`
- **connect-src:** `googleads.g.doubleclick.net`, `tpc.googlesyndication.com`, `*.google.com`
- **frame-src:** `adtrafficquality.google`, `*.adtrafficquality.google`, `fundingchoicesmessages.google.com`

_注：Googleは予測不可能なサブドメインを使用するため、`*.google.com`のようなワイルドカードが必要です。_

</Step>

<Step number="4" title="最終的なクリーンな設定">

開発環境（HMR）と本番環境（AdSense）の両方に対応した、`next.config.ts` の最終設定がこちらです：

```tsx
async headers() {
  const isDev = process.env.NODE_ENV === "development";

  const csp = [
    "default-src 'self'",
    `script-src 'self' 'unsafe-inline' ${isDev ? "'unsafe-eval'" : ""} https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com`,
    `connect-src 'self' ${isDev ? "ws://localhost:* ws://127.0.0.1:*" : ""} https://www.google-analytics.com https://www.googletagmanager.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://tpc.googlesyndication.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com https://*.google.com`,
    "frame-src 'self' https://googleads.g.doubleclick.net https://tpc.googlesyndication.com https://*.google.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com",
    "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
    "object-src 'none'",
  ].join("; ");

  return [
    {
      source: "/(.*)",
      headers: [
        { key: "Content-Security-Policy", value: csp },
        // ... 他のヘッダー
      ],
    },
  ];
}
```

</Step>

---

## 最終チェックリスト

<Checklist>
  <CheckItem>
    `unsafe-eval` が開発環境でのみ許可されていることを確認する
  </CheckItem>
  <CheckItem>本番環境のコンソールに赤いエラーがないか確認する</CheckItem>
  <CheckItem>`object-src` が 'none' に設定されているか確認する</CheckItem>
  <CheckItem>広告ブロックを無効にしてAdSenseの読み込みをテストする</CheckItem>
</Checklist>

---

**Next.jsサイトのセキュリティでお困りですか？** CSP設定、ヘッダー、セキュリティなどの難しい部分は私たちにお任せください。[サービス詳細](/services?lang=ja)をご覧いただくか、[お問い合わせ](/contact?lang=ja)からご相談ください。
