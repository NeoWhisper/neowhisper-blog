---
title: "From 6 CSP Errors to Zero: Debugging Content Security Policy for AdSense"
date: "2026-02-09"
excerpt: "AdSense scripts blocked by CSP? Console full of frame-src errors? Here's how I debugged and fixed 6 Content Security Policy violations in production—step by step."
category: "Next.js"
coverImage: "/images/csp-debugging-cover.png"
author:
  name: "NeoWhisper"
  picture: "/images/author.png"
---

I thought our site was AdSense-ready. Clean code, proper setup, everything by the book. Then I opened DevTools with ad blockers disabled.

**Six bright red CSP errors stared back at me.**

Every single AdSense script was blocked. The ads wouldn't load. The tracking wouldn't work. And I had no idea which domains Google actually needed until I saw them fail in real-time.

---

## The Problem: CSP Blocks Everything Google Needs

Content Security Policy (CSP) is a security header that tells browsers: "Only load resources from domains I explicitly allow." In Next.js, a basic policy might look like this:

```tsx
const csp = [
  "default-src 'self'",
  "script-src 'self'",
  "frame-src 'self'",
].join("; ");
```

This is very secure. It's also why AdSense breaks—Google needs to load external scripts and frames from multiple domains.

---

<Step number="1" title="Reproduce the Problem">

Don't guess what's blocked. See it fail in real-time by following these steps:

1. **Disable ad blockers** (they hide the real CSP errors).
2. Open DevTools → **Console**.
3. Load your page and look for the red "Refused to load..." errors.
4. **Write down every blocked domain.**

</Step>

<Step number="2" title="The Development Environment Trap">

If you just look at production errors, you'll miss the development-only requirements.

**In development (Next.js `npm run dev`), you need two extra permissions:**

1.  **`unsafe-eval`**: Next.js uses `eval()` for Hot Module Replacement (HMR).
2.  **`ws://localhost`**: Extensions like Console Ninja and HMR use WebSockets.

If you block these, your local dev environment will break.

<Callout type="info">

**The Fix:** Conditionally allow these **only** in development mode.

```ts
const isDev = process.env.NODE_ENV === "development";

const scriptSrc = [
  "'self'",
  "'unsafe-inline'",
  isDev ? "'unsafe-eval'" : "", // Allow eval in dev
  "https://www.googletagmanager.com",
  // ... other domains
]
  .filter(Boolean)
  .join(" ");

const connectSrc = [
  "'self'",
  isDev ? "ws://localhost:* ws://127.0.0.1:*" : "", // Allow WebSockets in dev
  "https://www.google-analytics.com",
  // ... other domains
]
  .filter(Boolean)
  .join(" ");
```

</Callout>

</Step>

<Step number="3" title="The AdSense Allowlist">

Through trial and error, here is the list of domains Google AdSense actually needs for production:

- **script-src:** `googletagmanager.com`, `google-analytics.com`, `pagead2.googlesyndication.com`
- **connect-src:** `googleads.g.doubleclick.net`, `tpc.googlesyndication.com`, `*.google.com`
- **frame-src:** `adtrafficquality.google`, `*.adtrafficquality.google`, `fundingchoicesmessages.google.com`

_Note: The wildcard `*.google.com` is necessary because Google uses unpredictable subdomains._

</Step>

<Step number="4" title="Final Clean Configuration">

Here is the final configuration in `next.config.ts` that handles both Development (HMR) and Production (AdSense):

```tsx
async headers() {
  const isDev = process.env.NODE_ENV === "development";

  const csp = [
    "default-src 'self'",
    `script-src 'self' 'unsafe-inline' ${isDev ? "'unsafe-eval'" : ""} https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com`,
    `connect-src 'self' ${isDev ? "ws://localhost:* ws://127.0.0.1:*" : ""} https://www.google-analytics.com https://www.googletagmanager.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://tpc.googlesyndication.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com https://*.google.com`,
    "frame-src 'self' https://googleads.g.doubleclick.net https://tpc.googlesyndication.com https://*.google.com https://adtrafficquality.google https://*.adtrafficquality.google https://fundingchoicesmessages.google.com",
    "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
    "object-src 'none'",
  ].join("; ");

  return [
    {
      source: "/(.*)",
      headers: [
        { key: "Content-Security-Policy", value: csp },
        // ... other headers
      ],
    },
  ];
}
```

</Step>

---

## Final Checklist

<Checklist>
  <CheckItem>Verify `unsafe-eval` is ONLY allowed in development</CheckItem>
  <CheckItem>Check the Console in Production for any red errors</CheckItem>
  <CheckItem>Confirm `object-src` is 'none'</CheckItem>
  <CheckItem>Test AdSense loading with ad blockers disabled</CheckItem>
</Checklist>

---

**Need help securing your Next.js site?** We handle the tricky parts of CSP, headers, and security so you don't have to. Check out our [services](/services) or [get in touch](/contact).
