---
title: "Cloudflare TurnstileとResendを使用した、商用レベルのコンタクトフォームの構築"
date: "2026-02-09"
excerpt: "スパムや配信エラーに悩まされるのはもう終わりに。Turnstileによる保護とResendによる確実な配信を組み合わせ、実際に本番環境で「機能する」コンタクトフォームを構築する方法を解説します。"
category: "Next.js"
coverImage: "/images/contact-form-cover.png"
author:
  name: "NeoWhisper"
  picture: "/images/author.png"
---

コンタクトフォームはシンプルであるべきです。本番環境にデプロイするまでは。

公開した途端、スパムが押し寄せ、メールは迷惑メールフォルダに振り分けられ、ユーザーは空のフォームを送信してくる。受信トレイはBotの通知で埋め尽くされ、肝心の本物の問い合わせが埋もれてしまう。

私は先日、当サイトの[コンタクトフォーム](/contact?lang=ja)を再構築しました。ここでは、実際に「機能する」フォームの作り方を、理論抜きで紹介します。実際のユーザー（と実際のBot）がアクセスし始めたときに本当に重要となるパターンだけを凝縮しました。

---

## 「シンプル」なコンタクトフォームの問題点

基本的なコンタクトフォームを作るのは簡単ですが、本番環境では以下の4つの理由で破綻します：

1. **スパムBot**: 公開後数時間以内に大量のゴミが送りつけられます。
2. **メールの到達性**: 自前サーバーからのメールはGmailなどの大手プロバイダにスパム判定されがちです。
3. **フィードバック不足**: サーバーサイドでエラーが起きても、ユーザーは何が起きたか分りません。
4. **プログレッシブ・エンハンスメントの欠如**: JavaScriptが無効な環境では動作しません。

<Callout type="warning">
  2026年のBotが簡単に回避してしまうハニーポットではなく、本物のスパム保護が必要です。また、SPF、DKIM、DMARCといった信頼性の高いメール配信設定と、堅牢なUXも欠かせません。
</Callout>

---

## なぜ Cloudflare Turnstile + Resend なのか？

**Cloudflare Turnstile** は、Googleによる追跡を伴わない、最新のreCAPTCHA代替手段です。ほとんどのユーザーには見えず、妥当なアクセス量であれば無料で利用でき、Botを確実に阻止します。

**Resend** は、SendGridやMailgunに代わる現代的な選択肢です。クリーンなAPI、優れた到達性、そして良心的な価格設定が魅力です。

---

<Step number="1" title="Turnstileをフォームに追加する">

まず、[Cloudflare](https://dash.cloudflare.com/?to=/:account/turnstile)からTurnstileのサイトキーを取得します。

それを `.env.local` に追加します：

```bash
NEXT_PUBLIC_TURNSTILE_SITE_KEY=your-site-key
TURNSTILE_SECRET_KEY=your-secret-key
```

次に、ウィジェットをフォームに配置します：

```tsx
"use client";

export default function ContactForm() {
  return (
    <form method="POST" action="/api/contact">
      <input name="name" required />
      <input name="email" type="email" required />
      <textarea name="details" required />

      {/* Turnstile チャレンジ */}
      <div
        className="cf-turnstile"
        data-sitekey={process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY}
      />

      <button type="submit">送信</button>

      <Script
        src="https://challenges.cloudflare.com/turnstile/v0/api.js"
        async
        defer
      />
    </form>
  );
}
```

</Step>

<Step number="2" title="サーバーサイドでトークンを検証する">

APIルート (`/api/contact/route.ts`) で、メールを送信する前にトークンを確認します。**クライアント側のトークンは偽装可能なため、必ずサーバーサイドで検証してください。**

```tsx
export async function POST(request: Request) {
  const formData = await request.formData();
  const turnstileToken = formData.get("cf-turnstile-response");

  if (!turnstileToken) {
    return NextResponse.json(
      { ok: false, message: "スパム検証に失敗しました。" },
      { status: 400 },
    );
  }

  // Cloudflare で検証
  const verifyResponse = await fetch(
    "https://challenges.cloudflare.com/turnstile/v0/siteverify",
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        secret: process.env.TURNSTILE_SECRET_KEY,
        response: turnstileToken,
      }),
    },
  );

  const verifyData = await verifyResponse.json();

  if (!verifyData.success) {
    return NextResponse.json(
      { ok: false, message: "スパム検証に失敗しました。" },
      { status: 400 },
    );
  }
}
```

</Step>

<Step number="3" title="Resendでメールを送信する">

[Resend](https://resend.com/api-keys)からAPIキーを取得し、彼らのクリーンなAPIを使ってメールを送信します：

```tsx
const emailPayload = {
  from: process.env.RESEND_FROM,
  to: [process.env.RESEND_TO],
  subject: `${formData.get("name")}様からの新しいお問い合わせ`,
  reply_to: formData.get("email"),
  text: `お名前: ${formData.get("name")}\nメール: ${formData.get("email")}\n\n${formData.get("details")}`,
};

const emailResponse = await fetch("https://api.resend.com/emails", {
  method: "POST",
  headers: {
    Authorization: `Bearer ${process.env.RESEND_API_KEY}`,
    "Content-Type": "application/json",
  },
  body: JSON.stringify(emailPayload),
});
```

</Step>

<Step number="4" title="メールの到達性を改善する">

メールを送ること自体は簡単ですが、確実に「受信トレイ」に届けるのは至難の業です。以下の3つのDNSレコードが必要になります：

<Callout type="info">

**DNS 設定の要件:**

- **SPF:** `v=spf1 include:_spf.resend.com ~all`
- **DKIM:** Resendのダッシュボードで生成されます。
- **DMARC:** `v=DMARC1; p=quarantine; rua=mailto:postmaster@yourdomain.com; pct=100; adkim=s; aspf=s`

</Callout>

これらが設定されていないと、GmailやOutlookはあなたのメールをスパムとしてマークしたり、完全に拒否したりします。当サイトの[コンタクトフォーム](/contact?lang=ja)も、DMARCを追加するまで数週間まともに機能していませんでした。

</Step>

<Step number="5" title="高度な UI & UX の実装">

### プログレッシブ・エンハンスメント

JavaScriptが読み込まれなかった場合でも、フォームが動作するようにします。APIルートでコンテンツタイプを検出することで、ネイティブなフォーム送信に対応できます：

```tsx
const contentType = request.headers.get("content-type") ?? "";
const isFormSubmit = contentType.includes("application/x-www-form-urlencoded");

if (isFormSubmit) {
  return NextResponse.redirect(
    new URL("/contact?success=1&lang=ja", request.url),
    303,
  );
}
```

### 具体的なエラーハンドリング

汎用的なエラーメッセージを返すのではなく、何が間違っているのか（必須項目の漏れ、無効なメール形式、認証失敗など）を具体的に伝えることで、ユーザーが修正しやすくします。

</Step>

---

## 最終チェックリスト

<Checklist>
  <CheckItem>
    Turnstileを「チャレンジ完了」と「未完了」の両方でテストする
  </CheckItem>
  <CheckItem>
    MXToolbox等でDNSレコード(SPF/DKIM/DMARC)が正しく設定されているか確認する
  </CheckItem>
  <CheckItem>Gmail、Outlook、Yahoo等への到達テストを行う</CheckItem>
  <CheckItem>
    JavaScriptを無効にして、フォームが正常に送信されるか確認する
  </CheckItem>
  <CheckItem>
    サーバーログを確認し、Resend APIからのエラーが捕捉されているかチェックする
  </CheckItem>
</Checklist>

---

**商用レベルのコンタクトフォーム構築でお困りですか？** スパム対策からメール到達性の最適化まで、Next.js開発の細かなテクニックを熟知しています。[サービス詳細](/services?lang=ja)をご覧いただくか、[お問い合わせ](/contact?lang=ja)からお気軽にご相談ください。

---

**関連記事：** 多言語サイトを構築されている方は、[AdSense対応の多言語Next.jsサイト出荷ガイド](/blog/adsense-ready-multilingual-nextjs?lang=ja)もぜひご覧ください。
